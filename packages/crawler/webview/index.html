<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬è€ƒèŒä½æ•°æ®é‡‡é›†ç³»ç»Ÿ</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#3b82f6;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--bg-dark:#1e293b;--bg-card:#fff;--bg-body:#f1f5f9;--text-primary:#1e293b;--text-secondary:#64748b;--border:#e2e8f0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Microsoft YaHei',sans-serif;background:var(--bg-body);color:var(--text-primary);height:100vh;overflow:hidden}
        .app{display:flex;height:100vh}
        .sidebar{width:220px;background:var(--bg-dark);color:#fff;display:flex;flex-direction:column}
        .sidebar-header{padding:16px;border-bottom:1px solid rgba(255,255,255,.1)}
        .sidebar-header h1{font-size:14px}
        .sidebar-header .ver{font-size:11px;color:rgba(255,255,255,.5)}
        .nav{flex:1;padding:8px 0;overflow-y:auto}
        .nav-item{display:flex;align-items:center;padding:10px 16px;cursor:pointer;color:rgba(255,255,255,.7);font-size:13px}
        .nav-item:hover{background:rgba(255,255,255,.05)}
        .nav-item.active{background:rgba(59,130,246,.2);color:#fff;border-left:3px solid var(--primary)}
        .nav-item svg{width:18px;height:18px;margin-right:10px}
        .main{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .content{flex:1;display:flex;overflow:hidden}
        .content-main{flex:1;padding:20px;overflow-y:auto}
        .log-panel{width:280px;background:var(--bg-card);border-left:1px solid var(--border);display:flex;flex-direction:column}
        .log-header{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .log-content{flex:1;overflow-y:auto;padding:8px;font-family:Consolas,monospace;font-size:11px;background:#f8fafc}
        .log-entry{padding:3px 6px;border-radius:3px;margin-bottom:3px}
        .log-entry.info{background:#e0f2fe;color:#0369a1}
        .log-entry.error{background:#fee2e2;color:#dc2626}
        .btn{padding:6px 12px;border:none;border-radius:5px;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:4px}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-success{background:var(--success);color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-secondary{background:var(--border);color:var(--text-primary)}
        .btn-sm{padding:4px 8px;font-size:12px}
        .card{background:var(--bg-card);border-radius:10px;border:1px solid var(--border);margin-bottom:16px}
        .card-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .card-header h3{font-size:14px}
        .card-body{padding:16px}
        table{width:100%;border-collapse:collapse}
        th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border)}
        th{background:#f8fafc;font-size:12px;color:var(--text-secondary)}
        td{font-size:13px}
        .badge{padding:3px 8px;border-radius:10px;font-size:11px}
        .badge-success{background:#dcfce7;color:#16a34a}
        .badge-warning{background:#fef3c7;color:#b45309}
        .badge-info{background:#e0f2fe;color:#0369a1}
        .badge-secondary{background:var(--border);color:var(--text-secondary)}
        .progress{height:6px;background:var(--border);border-radius:3px;overflow:hidden}
        .progress-bar{height:100%;background:var(--primary);border-radius:3px}
        .page{display:none}
        .page.active{display:block}
        .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
        .stat-card{background:var(--bg-card);border-radius:10px;padding:16px;border:1px solid var(--border)}
        .stat-card .val{font-size:28px;font-weight:700;color:var(--primary)}
        .stat-card .lbl{font-size:12px;color:var(--text-secondary);margin-top:2px}
        .toolbar{display:flex;align-items:center;gap:10px;margin-bottom:12px}
        .toolbar-spacer{flex:1}
        .form-group{margin-bottom:12px}
        .form-group label{display:block;font-size:13px;margin-bottom:4px;color:var(--text-secondary)}
        .form-control{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px}
        .form-control:focus{outline:none;border-color:var(--primary)}
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:1000}
        .modal-overlay.show{display:flex}
        .modal{background:var(--bg-card);border-radius:10px;width:400px;max-width:90%}
        .modal-header{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-body{padding:16px}
        .modal-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
        .spider-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:5px;margin:4px 0}
        .spider-item:hover{background:#f8fafc}
        .spider-status{width:8px;height:8px;border-radius:50%;margin-right:8px}
        .spider-status.running{background:var(--success)}
        .spider-status.stopped{background:var(--text-secondary)}
        .tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:16px}
        .tab{padding:10px 16px;cursor:pointer;font-size:13px;color:var(--text-secondary);border-bottom:2px solid transparent}
        .tab.active{color:var(--primary);border-bottom-color:var(--primary)}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .close-btn{background:none;border:none;cursor:pointer;color:var(--text-secondary)}
        ::-webkit-scrollbar{width:6px}
        ::-webkit-scrollbar-track{background:#f1f5f9}
        ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
    </style>
</head>
<body>
<div class="app">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>å…¬è€ƒæ•°æ®é‡‡é›†ç³»ç»Ÿ</h1>
            <div class="ver">v1.0.0</div>
        </div>
        <nav class="nav">
            <div class="nav-item active" data-page="dashboard">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                æ¦‚è§ˆ
            </div>
            <div class="nav-item" data-page="spiders">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
                çˆ¬è™«ç®¡ç†
            </div>
            <div class="nav-item" data-page="tasks">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                ä»»åŠ¡ç›‘æ§
            </div>
            <div class="nav-item" data-page="list-pages">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                åˆ—è¡¨é¡µç®¡ç†
            </div>
            <div class="nav-item" data-page="data">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>
                æ•°æ®æµè§ˆ
            </div>
            <div class="nav-item" data-page="review">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                å¾…å®¡æ ¸
            </div>
            <div class="nav-item" data-page="test">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                æµ‹è¯•é‡‡é›†
            </div>
            <div class="nav-item" data-page="settings">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                ç³»ç»Ÿè®¾ç½®
            </div>
        </nav>
    </aside>

    <main class="main">
        <div class="content">
            <div class="content-main">
                <!-- Dashboard -->
                <div class="page active" id="page-dashboard">
                    <h2 style="margin-bottom:20px">ç³»ç»Ÿæ¦‚è§ˆ</h2>
                    <div class="grid-4" id="stats-cards">
                        <div class="stat-card"><div class="val" id="total-ann">0</div><div class="lbl">å…¬å‘Šæ€»æ•°</div></div>
                        <div class="stat-card"><div class="val" id="total-pos">0</div><div class="lbl">èŒä½æ€»æ•°</div></div>
                        <div class="stat-card"><div class="val" id="pending-rev">0</div><div class="lbl">å¾…å®¡æ ¸</div></div>
                        <div class="stat-card"><div class="val" id="today-crawl">0</div><div class="lbl">ä»Šæ—¥é‡‡é›†</div></div>
                    </div>
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><h3>çˆ¬è™«çŠ¶æ€</h3><button class="btn btn-sm btn-secondary" onclick="loadSpiders()">åˆ·æ–°</button></div>
                            <div class="card-body" id="spider-list"></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>æœ€è¿‘ä»»åŠ¡</h3><button class="btn btn-sm btn-secondary" onclick="loadTasks()">åˆ·æ–°</button></div>
                            <div class="card-body"><table><thead><tr><th>ä»»åŠ¡</th><th>çŠ¶æ€</th><th>è¿›åº¦</th></tr></thead><tbody id="recent-tasks"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- Spiders -->
                <div class="page" id="page-spiders">
                    <h2 style="margin-bottom:20px">çˆ¬è™«ç®¡ç†</h2>
                    <div class="toolbar">
                        <button class="btn btn-success" onclick="startAllSpiders()">å¯åŠ¨å…¨éƒ¨</button>
                        <button class="btn btn-danger" onclick="stopAllSpiders()">åœæ­¢å…¨éƒ¨</button>
                        <div class="toolbar-spacer"></div>
                        <button class="btn btn-secondary" onclick="loadSpiders()">åˆ·æ–°</button>
                    </div>
                    <div class="card"><div class="card-body" id="spider-tree"></div></div>
                </div>

                <!-- Tasks -->
                <div class="page" id="page-tasks">
                    <h2 style="margin-bottom:20px">ä»»åŠ¡ç›‘æ§</h2>
                    <div class="toolbar">
                        <button class="btn btn-secondary" onclick="loadTasks()">åˆ·æ–°</button>
                        <button class="btn btn-secondary" onclick="clearCompleted()">æ¸…ç©ºå·²å®Œæˆ</button>
                        <div class="toolbar-spacer"></div>
                        <select class="form-control" style="width:auto" id="task-filter" onchange="loadTasks()">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="running">è¿è¡Œä¸­</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="failed">å¤±è´¥</option>
                        </select>
                    </div>
                    <div class="card"><div class="card-body"><table><thead><tr><th>ä»»åŠ¡ID</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th>è¿›åº¦</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody id="tasks-table"></tbody></table></div></div>
                </div>

                <!-- List Pages -->
                <div class="page" id="page-list-pages">
                    <h2 style="margin-bottom:20px">åˆ—è¡¨é¡µç®¡ç†</h2>
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="showModal('add-page-modal')">æ·»åŠ åˆ—è¡¨é¡µ</button>
                        <div class="toolbar-spacer"></div>
                        <button class="btn btn-secondary" onclick="loadListPages()">åˆ·æ–°</button>
                    </div>
                    <div class="card"><div class="card-body"><table><thead><tr><th>æ¥æº</th><th>URL</th><th>é¢‘ç‡</th><th>çŠ¶æ€</th><th>æ–‡ç« æ•°</th><th>æ“ä½œ</th></tr></thead><tbody id="pages-table"></tbody></table></div></div>
                </div>

                <!-- Data -->
                <div class="page" id="page-data">
                    <h2 style="margin-bottom:20px">æ•°æ®æµè§ˆ</h2>
                    <div class="tabs">
                        <div class="tab active" data-tab="announcements">å…¬å‘Šæ•°æ®</div>
                        <div class="tab" data-tab="positions">èŒä½æ•°æ®</div>
                    </div>
                    <div class="tab-content active" id="tab-announcements">
                        <div class="toolbar"><button class="btn btn-secondary" onclick="loadAnnouncements()">åˆ·æ–°</button><button class="btn btn-secondary" onclick="exportData('announcements')">å¯¼å‡º</button></div>
                        <div class="card"><div class="card-body"><table><thead><tr><th>æ ‡é¢˜</th><th>ç±»å‹</th><th>å‘å¸ƒæ—¥æœŸ</th><th>æ¥æº</th><th>çŠ¶æ€</th></tr></thead><tbody id="ann-table"></tbody></table></div></div>
                    </div>
                    <div class="tab-content" id="tab-positions">
                        <div class="toolbar"><button class="btn btn-secondary" onclick="loadPositions()">åˆ·æ–°</button><button class="btn btn-secondary" onclick="exportData('positions')">å¯¼å‡º</button></div>
                        <div class="card"><div class="card-body"><table><thead><tr><th>èŒä½</th><th>éƒ¨é—¨</th><th>å­¦å†</th><th>åœ°ç‚¹</th><th>äººæ•°</th><th>ç½®ä¿¡åº¦</th></tr></thead><tbody id="pos-table"></tbody></table></div></div>
                    </div>
                </div>

                <!-- Review -->
                <div class="page" id="page-review">
                    <h2 style="margin-bottom:20px">å¾…å®¡æ ¸</h2>
                    <div class="toolbar">
                        <button class="btn btn-success" onclick="batchApprove()">æ‰¹é‡é€šè¿‡</button>
                        <div class="toolbar-spacer"></div>
                        <span id="review-stats">å¾…å®¡æ ¸: 0</span>
                        <button class="btn btn-secondary" onclick="loadReview()">åˆ·æ–°</button>
                    </div>
                    <div class="card"><div class="card-body"><table><thead><tr><th><input type="checkbox" id="sel-all"></th><th>èŒä½</th><th>éƒ¨é—¨</th><th>ç½®ä¿¡åº¦</th><th>é—®é¢˜</th><th>æ“ä½œ</th></tr></thead><tbody id="review-table"></tbody></table></div></div>
                </div>

                <!-- Test Page -->
                <div class="page" id="page-test">
                    <h2 style="margin-bottom:20px">æµ‹è¯•é‡‡é›†ä¸AIåˆ†æ</h2>
                    <div class="card">
                        <div class="card-header"><h3>è¾“å…¥æ–‡ç« URL</h3></div>
                        <div class="card-body">
                            <div style="display:flex;gap:10px;align-items:flex-end">
                                <div class="form-group" style="flex:1;margin-bottom:0">
                                    <label>æ–‡ç« é“¾æ¥</label>
                                    <input type="url" class="form-control" id="test-url" placeholder="https://example.com/article/...">
                                </div>
                                <button class="btn btn-primary" onclick="fetchArticle()" id="fetch-btn">é‡‡é›†æ–‡ç« </button>
                            </div>
                            <div style="margin-top:12px;font-size:12px;color:var(--text-secondary)">
                                æ”¯æŒé‡‡é›†å„ç±»å…¬è€ƒæ‹›è˜å…¬å‘Šé¡µé¢ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æå–å†…å®¹å¹¶è¿›è¡ŒAIåˆ†æ
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><h3>é‡‡é›†ç»“æœ</h3><span class="badge badge-secondary" id="fetch-status">ç­‰å¾…é‡‡é›†</span></div>
                            <div class="card-body">
                                <div id="article-content" style="min-height:300px;max-height:400px;overflow-y:auto;background:#f8fafc;padding:12px;border-radius:6px;font-size:13px;line-height:1.6;white-space:pre-wrap;word-break:break-all">
                                    <div style="color:var(--text-secondary);text-align:center;padding:40px">è¯·è¾“å…¥URLå¹¶ç‚¹å‡»é‡‡é›†</div>
                                </div>
                                <div style="margin-top:12px;display:flex;gap:8px">
                                    <div style="flex:1"><strong style="font-size:12px;color:var(--text-secondary)">æ ‡é¢˜:</strong><div id="article-title" style="font-size:13px">-</div></div>
                                    <div><strong style="font-size:12px;color:var(--text-secondary)">å­—æ•°:</strong><div id="article-length" style="font-size:13px">-</div></div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>AIåˆ†æç»“æœ</h3><button class="btn btn-sm btn-primary" onclick="analyzeArticle()" id="analyze-btn" disabled>å¼€å§‹åˆ†æ</button></div>
                            <div class="card-body">
                                <div id="ai-result" style="min-height:300px;max-height:400px;overflow-y:auto">
                                    <div style="color:var(--text-secondary);text-align:center;padding:40px">è¯·å…ˆé‡‡é›†æ–‡ç« å†…å®¹</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header"><h3>æå–çš„èŒä½ä¿¡æ¯</h3><span class="badge badge-info" id="position-count">0 ä¸ªèŒä½</span></div>
                        <div class="card-body">
                            <table>
                                <thead>
                                    <tr>
                                        <th>èŒä½åç§°</th>
                                        <th>æ‹›å½•å•ä½</th>
                                        <th>å­¦å†è¦æ±‚</th>
                                        <th>ä¸“ä¸šè¦æ±‚</th>
                                        <th>æ‹›å½•äººæ•°</th>
                                        <th>ç½®ä¿¡åº¦</th>
                                    </tr>
                                </thead>
                                <tbody id="extracted-positions">
                                    <tr><td colspan="6" style="text-align:center;color:var(--text-secondary)">æš‚æ— æ•°æ®</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="page" id="page-settings">
                    <h2 style="margin-bottom:20px">ç³»ç»Ÿè®¾ç½®</h2>
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><h3>æ•°æ®åº“é…ç½®</h3></div>
                            <div class="card-body">
                                <div class="form-group"><label>MySQL Host</label><input type="text" class="form-control" id="cfg-mysql-host" value="localhost"></div>
                                <div class="form-group"><label>MySQL Port</label><input type="number" class="form-control" id="cfg-mysql-port" value="3306"></div>
                                <div class="form-group"><label>æ•°æ®åº“å</label><input type="text" class="form-control" id="cfg-mysql-db" value="cse_crawler"></div>
                                <div class="form-group"><label>ç”¨æˆ·å</label><input type="text" class="form-control" id="cfg-mysql-user" value="root"></div>
                                <div class="form-group"><label>å¯†ç </label><input type="password" class="form-control" id="cfg-mysql-pass"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>AIé…ç½®</h3></div>
                            <div class="card-body">
                                <div class="form-group"><label>Provider</label><select class="form-control" id="cfg-ai-provider"><option value="openai">OpenAI</option><option value="anthropic">Anthropic</option><option value="zhipu">æ™ºè°±</option></select></div>
                                <div class="form-group"><label>API Key</label><input type="password" class="form-control" id="cfg-ai-key"></div>
                                <div class="form-group"><label>ç½®ä¿¡åº¦é˜ˆå€¼</label><input type="number" class="form-control" id="cfg-threshold" value="85"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>çˆ¬è™«é…ç½®</h3></div>
                            <div class="card-body">
                                <div class="form-group"><label>å¹¶å‘æ•°</label><input type="number" class="form-control" id="cfg-concurrent" value="16"></div>
                                <div class="form-group"><label>å»¶è¿Ÿ(ç§’)</label><input type="number" class="form-control" id="cfg-delay" value="1" step="0.1"></div>
                                <div class="form-group"><label>é‡è¯•æ¬¡æ•°</label><input type="number" class="form-control" id="cfg-retry" value="3"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3>Redisé…ç½®</h3></div>
                            <div class="card-body">
                                <div class="form-group"><label>Host</label><input type="text" class="form-control" id="cfg-redis-host" value="localhost"></div>
                                <div class="form-group"><label>Port</label><input type="number" class="form-control" id="cfg-redis-port" value="6379"></div>
                                <div class="form-group"><label>DB</label><input type="number" class="form-control" id="cfg-redis-db" value="0"></div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:16px;text-align:right"><button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button></div>
                </div>
            </div>

            <aside class="log-panel">
                <div class="log-header"><h3 style="font-size:13px">è¿è¡Œæ—¥å¿—</h3><button class="btn btn-sm btn-secondary" onclick="clearLogs()">æ¸…ç©º</button></div>
                <div class="log-content" id="log-content"></div>
            </aside>
        </div>
    </main>
</div>

<!-- Add Page Modal -->
<div class="modal-overlay" id="add-page-modal">
    <div class="modal">
        <div class="modal-header"><h3>æ·»åŠ åˆ—è¡¨é¡µ</h3><button class="close-btn" onclick="hideModal('add-page-modal')">âœ•</button></div>
        <div class="modal-body">
            <div class="form-group"><label>URL</label><input type="url" class="form-control" id="new-page-url" placeholder="https://..."></div>
            <div class="form-group"><label>æ¥æºåç§°</label><input type="text" class="form-control" id="new-page-source"></div>
            <div class="form-group"><label>çˆ¬å–é¢‘ç‡</label><select class="form-control" id="new-page-freq"><option value="every_2h">æ¯2å°æ—¶</option><option value="every_6h">æ¯6å°æ—¶</option><option value="daily">æ¯å¤©</option></select></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('add-page-modal')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="addListPage()">æ·»åŠ </button></div>
    </div>
</div>

<script>
let currentPage='dashboard';
document.addEventListener('DOMContentLoaded',()=>{initNav();initTabs();loadAll();startLogPoll();});

function initNav(){document.querySelectorAll('.nav-item').forEach(i=>i.addEventListener('click',()=>navTo(i.dataset.page)));}
function navTo(p){currentPage=p;document.querySelectorAll('.nav-item').forEach(i=>i.classList.toggle('active',i.dataset.page===p));document.querySelectorAll('.page').forEach(pg=>pg.classList.toggle('active',pg.id==='page-'+p));loadPageData(p);}
function loadPageData(p){switch(p){case'dashboard':loadStats();loadSpiders();loadTasks();break;case'spiders':loadSpiders();break;case'tasks':loadTasks();break;case'list-pages':loadListPages();break;case'data':loadAnnouncements();break;case'review':loadReview();break;case'settings':loadConfig();break;}}
function initTabs(){document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{let id=t.dataset.tab;t.closest('.page').querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));t.closest('.page').querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.getElementById('tab-'+id).classList.add('active');if(id==='positions')loadPositions();}));}

async function api(m,...a){try{if(window.pywebview?.api)return await window.pywebview.api[m](...a);return{success:true};}catch(e){return{success:false,error:e.message};}}
function loadAll(){loadStats();loadSpiders();loadTasks();}

async function loadStats(){let r=await api('get_statistics');if(r.success){let s=r.stats;document.getElementById('total-ann').textContent=s.total_announcements||0;document.getElementById('total-pos').textContent=s.total_positions||0;document.getElementById('pending-rev').textContent=s.pending_review||0;document.getElementById('today-crawl').textContent=s.today_crawled||0;}}

async function loadSpiders(){let r=await api('get_spiders');if(r.success)renderSpiders(r.spiders);}
function renderSpiders(spiders){let html=spiders.map(s=>`<div class="spider-item"><div style="display:flex;align-items:center"><div class="spider-status ${s.status}"></div><strong>${s.name}</strong></div><div><button class="btn btn-sm btn-success" onclick="startSpider('${s.id}')">å¯åŠ¨</button> <button class="btn btn-sm btn-danger" onclick="stopSpider('${s.id}')">åœæ­¢</button></div></div>`).join('');document.getElementById('spider-list').innerHTML=html;document.getElementById('spider-tree').innerHTML=html;}
async function startSpider(id){await api('start_spider',id);loadSpiders();}
async function stopSpider(id){await api('stop_spider',id);loadSpiders();}
async function startAllSpiders(){let r=await api('get_spiders');if(r.success)for(let s of r.spiders)await api('start_spider',s.id);loadSpiders();}
async function stopAllSpiders(){await api('stop_all_spiders');loadSpiders();}

async function loadTasks(){let f=document.getElementById('task-filter')?.value||'all';let r=await api('get_tasks',f);if(r.success)renderTasks(r.tasks);}
function renderTasks(tasks){let t=document.getElementById('tasks-table'),rt=document.getElementById('recent-tasks');if(!tasks.length){if(t)t.innerHTML='<tr><td colspan="6" style="text-align:center;color:#64748b">æš‚æ— ä»»åŠ¡</td></tr>';if(rt)rt.innerHTML='<tr><td colspan="3" style="text-align:center;color:#64748b">æš‚æ— ä»»åŠ¡</td></tr>';return;}if(t)t.innerHTML=tasks.map(x=>`<tr><td><code>${x.id}</code></td><td>${x.type}</td><td><span class="badge badge-${x.status==='running'?'warning':x.status==='completed'?'success':'secondary'}">${x.status}</span></td><td><div class="progress" style="width:80px"><div class="progress-bar" style="width:${x.progress}%"></div></div></td><td>${x.created_at}</td><td><button class="btn btn-sm btn-danger" onclick="cancelTask('${x.id}')" ${x.status!=='running'?'disabled':''}>å–æ¶ˆ</button></td></tr>`).join('');if(rt)rt.innerHTML=tasks.slice(0,5).map(x=>`<tr><td>${x.name}</td><td><span class="badge badge-${x.status==='running'?'warning':'success'}">${x.status}</span></td><td><div class="progress" style="width:60px"><div class="progress-bar" style="width:${x.progress}%"></div></div></td></tr>`).join('');}
async function cancelTask(id){await api('cancel_task',id);loadTasks();}
async function clearCompleted(){await api('clear_completed_tasks');loadTasks();}

async function loadListPages(){let r=await api('get_list_pages');if(r.success)renderPages(r.pages);}
function renderPages(pages){let t=document.getElementById('pages-table');if(!pages.length){t.innerHTML='<tr><td colspan="6" style="text-align:center;color:#64748b">æš‚æ— åˆ—è¡¨é¡µ</td></tr>';return;}t.innerHTML=pages.map(p=>`<tr><td><strong>${p.source_name}</strong></td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${p.url}</td><td>${p.crawl_frequency}</td><td><span class="badge badge-${p.status==='active'?'success':'secondary'}">${p.status}</span></td><td>${p.article_count}</td><td><button class="btn btn-sm btn-secondary" onclick="testPage('${p.url}')">æµ‹è¯•</button> <button class="btn btn-sm btn-danger" onclick="deletePage(${p.id})">åˆ é™¤</button></td></tr>`).join('');}
async function addListPage(){let url=document.getElementById('new-page-url').value,src=document.getElementById('new-page-source').value,freq=document.getElementById('new-page-freq').value;if(!url||!src)return alert('è¯·å¡«å†™å®Œæ•´');await api('add_list_page',url,src,freq);hideModal('add-page-modal');loadListPages();}
async function deletePage(id){if(confirm('ç¡®å®šåˆ é™¤?')){await api('delete_list_page',id);loadListPages();}}
async function testPage(url){let r=await api('test_list_page',url);alert(r.success?'æµ‹è¯•æˆåŠŸ: å‘ç° '+r.result.found+' æ¡':'æµ‹è¯•å¤±è´¥: '+r.error);}

async function loadAnnouncements(){let r=await api('get_announcements');if(r.success)renderAnn(r.announcements);}
function renderAnn(ann){let t=document.getElementById('ann-table');if(!ann.length){t.innerHTML='<tr><td colspan="5" style="text-align:center;color:#64748b">æš‚æ— æ•°æ®</td></tr>';return;}t.innerHTML=ann.map(a=>`<tr><td><strong>${a.title}</strong></td><td><span class="badge badge-info">${a.type}</span></td><td>${a.publish_date}</td><td>${a.source}</td><td><span class="badge badge-${a.status==='parsed'?'success':'warning'}">${a.status}</span></td></tr>`).join('');}

async function loadPositions(){let r=await api('get_positions');if(r.success)renderPos(r.positions);}
function renderPos(pos){let t=document.getElementById('pos-table');if(!pos.length){t.innerHTML='<tr><td colspan="6" style="text-align:center;color:#64748b">æš‚æ— æ•°æ®</td></tr>';return;}t.innerHTML=pos.map(p=>`<tr><td><strong>${p.name}</strong></td><td>${p.department}</td><td>${p.education}</td><td>${p.location}</td><td>${p.recruit_count}</td><td><div style="display:flex;align-items:center;gap:6px"><div class="progress" style="width:60px"><div class="progress-bar" style="width:${p.confidence}%;background:${p.confidence>=85?'#22c55e':p.confidence>=70?'#f59e0b':'#ef4444'}"></div></div><span>${p.confidence}%</span></div></td></tr>`).join('');}

async function loadReview(){let r=await api('get_review_items');if(r.success){renderReview(r.items);document.getElementById('review-stats').textContent='å¾…å®¡æ ¸: '+r.total;}}
function renderReview(items){let t=document.getElementById('review-table');if(!items.length){t.innerHTML='<tr><td colspan="6" style="text-align:center;color:#64748b">æš‚æ— å¾…å®¡æ ¸</td></tr>';return;}t.innerHTML=items.map(i=>`<tr><td><input type="checkbox" class="rev-cb" value="${i.id}"></td><td><strong>${i.position_name}</strong></td><td>${i.department}</td><td><div style="display:flex;align-items:center;gap:6px"><div class="progress" style="width:60px"><div class="progress-bar" style="width:${i.confidence}%;background:${i.confidence>=85?'#22c55e':i.confidence>=70?'#f59e0b':'#ef4444'}"></div></div><span>${i.confidence}%</span></div></td><td style="max-width:150px">${i.issues.join(', ')}</td><td><button class="btn btn-sm btn-success" onclick="approveItem(${i.id})">é€šè¿‡</button> <button class="btn btn-sm btn-danger" onclick="rejectItem(${i.id})">æ‹’ç»</button></td></tr>`).join('');}
async function approveItem(id){await api('approve_item',id);loadReview();}
async function rejectItem(id){let reason=prompt('æ‹’ç»åŸå› :');if(reason){await api('reject_item',id,reason);loadReview();}}
async function batchApprove(){let ids=[...document.querySelectorAll('.rev-cb:checked')].map(c=>parseInt(c.value));if(!ids.length)return alert('è¯·é€‰æ‹©é¡¹ç›®');await api('batch_approve',ids);loadReview();}

async function loadConfig(){let r=await api('get_config');if(r.success&&r.config){let c=r.config;if(c.database?.mysql){document.getElementById('cfg-mysql-host').value=c.database.mysql.host||'localhost';document.getElementById('cfg-mysql-port').value=c.database.mysql.port||3306;document.getElementById('cfg-mysql-db').value=c.database.mysql.database||'cse_crawler';document.getElementById('cfg-mysql-user').value=c.database.mysql.user||'root';}if(c.ai){document.getElementById('cfg-ai-provider').value=c.ai.provider||'openai';document.getElementById('cfg-threshold').value=c.ai.confidence_threshold||85;}if(c.spider){document.getElementById('cfg-concurrent').value=c.spider.concurrent_requests||16;document.getElementById('cfg-delay').value=c.spider.download_delay||1;document.getElementById('cfg-retry').value=c.spider.retry_times||3;}if(c.database?.redis){document.getElementById('cfg-redis-host').value=c.database.redis.host||'localhost';document.getElementById('cfg-redis-port').value=c.database.redis.port||6379;document.getElementById('cfg-redis-db').value=c.database.redis.db||0;}}}
async function saveConfig(){let cfg={'database.mysql.host':document.getElementById('cfg-mysql-host').value,'database.mysql.port':parseInt(document.getElementById('cfg-mysql-port').value),'database.mysql.database':document.getElementById('cfg-mysql-db').value,'database.mysql.user':document.getElementById('cfg-mysql-user').value,'ai.provider':document.getElementById('cfg-ai-provider').value,'ai.confidence_threshold':parseInt(document.getElementById('cfg-threshold').value),'spider.concurrent_requests':parseInt(document.getElementById('cfg-concurrent').value),'spider.download_delay':parseFloat(document.getElementById('cfg-delay').value),'spider.retry_times':parseInt(document.getElementById('cfg-retry').value)};await api('save_config',cfg);alert('é…ç½®å·²ä¿å­˜');}

async function exportData(type){await api('export_data',type);}

function startLogPoll(){setInterval(async()=>{let r=await api('get_logs');if(r.success)renderLogs(r.logs);},2000);}
function renderLogs(logs){let c=document.getElementById('log-content');c.innerHTML=logs.map(l=>`<div class="log-entry ${l.type}"><span style="color:#94a3b8">[${l.time}]</span> ${l.message}</div>`).join('');c.scrollTop=c.scrollHeight;}
async function clearLogs(){await api('clear_logs');document.getElementById('log-content').innerHTML='';}

function showModal(id){document.getElementById(id).classList.add('show');}
function hideModal(id){document.getElementById(id).classList.remove('show');}

// ==================== æµ‹è¯•é‡‡é›†åŠŸèƒ½ ====================
let currentArticle = null;

async function fetchArticle() {
    const url = document.getElementById('test-url').value.trim();
    if (!url) {
        alert('è¯·è¾“å…¥æ–‡ç« URL');
        return;
    }
    
    const btn = document.getElementById('fetch-btn');
    const status = document.getElementById('fetch-status');
    
    btn.disabled = true;
    btn.textContent = 'é‡‡é›†ä¸­...';
    status.textContent = 'é‡‡é›†ä¸­';
    status.className = 'badge badge-warning';
    document.getElementById('article-content').innerHTML = '<div style="text-align:center;padding:40px"><div class="spinner"></div>æ­£åœ¨é‡‡é›†æ–‡ç« å†…å®¹...</div>';
    
    try {
        const r = await api('fetch_article', url);
        if (r.success) {
            currentArticle = r.data;
            document.getElementById('article-title').textContent = r.data.title || 'æœªçŸ¥æ ‡é¢˜';
            document.getElementById('article-length').textContent = (r.data.content?.length || 0) + ' å­—';
            document.getElementById('article-content').textContent = r.data.content || 'æ— å†…å®¹';
            status.textContent = 'é‡‡é›†æˆåŠŸ';
            status.className = 'badge badge-success';
            document.getElementById('analyze-btn').disabled = false;
        } else {
            document.getElementById('article-content').innerHTML = '<div style="color:#ef4444;padding:20px">é‡‡é›†å¤±è´¥: ' + (r.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
            status.textContent = 'é‡‡é›†å¤±è´¥';
            status.className = 'badge badge-danger';
        }
    } catch (e) {
        document.getElementById('article-content').innerHTML = '<div style="color:#ef4444;padding:20px">é‡‡é›†é”™è¯¯: ' + e.message + '</div>';
        status.textContent = 'é”™è¯¯';
        status.className = 'badge badge-danger';
    } finally {
        btn.disabled = false;
        btn.textContent = 'é‡‡é›†æ–‡ç« ';
    }
}

async function analyzeArticle() {
    if (!currentArticle || !currentArticle.content) {
        alert('è¯·å…ˆé‡‡é›†æ–‡ç« å†…å®¹');
        return;
    }
    
    const btn = document.getElementById('analyze-btn');
    btn.disabled = true;
    btn.textContent = 'åˆ†æä¸­...';
    document.getElementById('ai-result').innerHTML = '<div style="text-align:center;padding:40px"><div class="spinner"></div>AIæ­£åœ¨åˆ†ææ–‡ç« å†…å®¹...</div>';
    
    try {
        const r = await api('analyze_article', currentArticle.content, currentArticle.title);
        if (r.success) {
            renderAIResult(r.data);
            if (r.data.positions && r.data.positions.length > 0) {
                renderExtractedPositions(r.data.positions);
            }
        } else {
            document.getElementById('ai-result').innerHTML = '<div style="color:#ef4444;padding:20px">åˆ†æå¤±è´¥: ' + (r.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
        }
    } catch (e) {
        document.getElementById('ai-result').innerHTML = '<div style="color:#ef4444;padding:20px">åˆ†æé”™è¯¯: ' + e.message + '</div>';
    } finally {
        btn.disabled = false;
        btn.textContent = 'å¼€å§‹åˆ†æ';
    }
}

function renderAIResult(data) {
    let html = '<div style="font-size:13px;line-height:1.8">';
    
    if (data.summary) {
        html += '<div style="margin-bottom:16px"><strong style="color:var(--primary)">ğŸ“ å†…å®¹æ‘˜è¦</strong><div style="background:#f0f9ff;padding:12px;border-radius:6px;margin-top:8px">' + data.summary + '</div></div>';
    }
    
    if (data.announcement_type) {
        html += '<div style="margin-bottom:12px"><strong>ğŸ“‹ å…¬å‘Šç±»å‹:</strong> <span class="badge badge-info">' + data.announcement_type + '</span></div>';
    }
    
    if (data.publish_date) {
        html += '<div style="margin-bottom:12px"><strong>ğŸ“… å‘å¸ƒæ—¥æœŸ:</strong> ' + data.publish_date + '</div>';
    }
    
    if (data.registration_time) {
        html += '<div style="margin-bottom:12px"><strong>â° æŠ¥åæ—¶é—´:</strong> ' + data.registration_time + '</div>';
    }
    
    if (data.exam_time) {
        html += '<div style="margin-bottom:12px"><strong>ğŸ“ è€ƒè¯•æ—¶é—´:</strong> ' + data.exam_time + '</div>';
    }
    
    if (data.total_positions) {
        html += '<div style="margin-bottom:12px"><strong>ğŸ‘¥ æ‹›å½•äººæ•°:</strong> ' + data.total_positions + ' äºº</div>';
    }
    
    if (data.key_requirements) {
        html += '<div style="margin-bottom:12px"><strong>ğŸ“Œ å…³é”®è¦æ±‚:</strong><ul style="margin:8px 0 0 20px">';
        data.key_requirements.forEach(req => {
            html += '<li>' + req + '</li>';
        });
        html += '</ul></div>';
    }
    
    if (data.confidence) {
        const confColor = data.confidence >= 85 ? '#22c55e' : data.confidence >= 70 ? '#f59e0b' : '#ef4444';
        html += '<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)"><strong>ğŸ¯ åˆ†æç½®ä¿¡åº¦:</strong> <span style="color:' + confColor + ';font-weight:bold">' + data.confidence + '%</span></div>';
    }
    
    html += '</div>';
    document.getElementById('ai-result').innerHTML = html;
}

function renderExtractedPositions(positions) {
    document.getElementById('position-count').textContent = positions.length + ' ä¸ªèŒä½';
    
    if (!positions.length) {
        document.getElementById('extracted-positions').innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary)">æœªæå–åˆ°èŒä½ä¿¡æ¯</td></tr>';
        return;
    }
    
    document.getElementById('extracted-positions').innerHTML = positions.map(p => {
        const confColor = (p.confidence || 0) >= 85 ? '#22c55e' : (p.confidence || 0) >= 70 ? '#f59e0b' : '#ef4444';
        return `<tr>
            <td><strong>${p.name || '-'}</strong></td>
            <td>${p.department || '-'}</td>
            <td>${p.education || '-'}</td>
            <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis">${p.major || '-'}</td>
            <td>${p.recruit_count || '-'}</td>
            <td><div style="display:flex;align-items:center;gap:6px">
                <div class="progress" style="width:60px"><div class="progress-bar" style="width:${p.confidence || 0}%;background:${confColor}"></div></div>
                <span>${p.confidence || 0}%</span>
            </div></td>
        </tr>`;
    }).join('');
}
</script>
</body>
</html>
